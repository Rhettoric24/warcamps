<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highprince: Warcamp Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap');

        :root {
            --alethi-blue: #1e3a8a;
            --gem-glow: #00f2ff;
            --parchment: #f4ece1;
        }

        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Lora', serif;
            background-image: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }

        h1, h2, h3, .font-cinzel { font-family: 'Cinzel', serif; }

        .warcamp-panel {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid #334155;
            backdrop-filter: blur(8px);
            border-radius: 0.75rem;
        }

        .gem-stat { text-shadow: 0 0 10px var(--gem-glow); color: var(--gem-glow); }

        .log-entry {
            border-left: 2px solid #3b82f6;
            padding-left: 8px;
            margin-bottom: 8px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .btn-alethi {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transition: all 0.2s;
            border: 1px solid #3b82f6;
        }

        .btn-alethi:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        .btn-alethi:disabled { opacity: 0.5; cursor: not-allowed; }

        .tab-btn.active { border-bottom: 2px solid var(--gem-glow); color: var(--gem-glow); }

        .stat-card { background: rgba(15, 23, 42, 0.6); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #1e293b; }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .progress-bar-striped {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
        }

        /* Modal Styles */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 50;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal.open { opacity: 1; pointer-events: all; }

        .alert-flash { animation: flashRed 1s infinite alternate; }
        @keyframes flashRed { from { box-shadow: 0 0 10px rgba(255,0,0,0.2) inset; } to { box-shadow: 0 0 50px rgba(255,0,0,0.6) inset; } }
        
        .warn-flash { animation: flashOrange 1s infinite alternate; }
        @keyframes flashOrange { from { box-shadow: 0 0 10px rgba(255,165,0,0.2) inset; } to { box-shadow: 0 0 50px rgba(255,165,0,0.6) inset; } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 relative">

    <div id="screen-overlay" class="fixed inset-0 pointer-events-none z-40"></div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full bg-slate-800 p-8 rounded-lg border-2 border-blue-900 shadow-2xl text-center">
            <h1 class="text-3xl font-cinzel text-blue-400 mb-2">The Shattered Plains</h1>
            <p class="text-slate-400 mb-6 italic">Enter your name, Highprince, to access your warcamp.</p>
            <input type="text" id="username-input" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white text-center mb-4 focus:border-blue-500 outline-none" placeholder="Highprince Name">
            <button onclick="game.login()" class="w-full btn-alethi py-3 rounded font-bold text-lg">ENTER COMMAND</button>
        </div>
    </div>

    <!-- GAME UI (Hidden until login) -->
    <div id="game-container" class="hidden">
        <header class="max-w-6xl mx-auto mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-blue-400 tracking-widest uppercase">Highprince <span id="player-name-display"></span></h1>
                    <div class="flex items-center gap-3 mt-1">
                        <p class="text-slate-400 italic">Military Command</p>
                        <span class="text-slate-600">|</span>
                        <div class="text-cyan-500 font-cinzel text-xs tracking-tighter bg-cyan-950/30 px-2 py-1 rounded">
                            <span id="display-date">Year 1, Month 1, Day 1</span> 
                            <span class="mx-1 text-slate-500">‚Ä¢</span>
                            <span id="display-time">Next Day in: --</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4 warcamp-panel p-4 px-6 overflow-x-auto w-full md:w-auto">
                    <div class="text-center min-w-[70px]">
                        <span class="block text-[10px] uppercase text-slate-400">Spheres</span>
                        <span id="res-spheres" class="text-lg font-bold text-yellow-500">15000</span>
                    </div>
                    <div class="text-center min-w-[70px]">
                        <span class="block text-[10px] uppercase text-slate-400">Gemhearts</span>
                        <span id="res-gemhearts" class="text-lg font-bold gem-stat">0</span>
                    </div>
                    <div class="text-center min-w-[70px]">
                        <span class="block text-[10px] uppercase text-slate-400">Provisions</span>
                        <div class="text-lg font-bold">
                            <span id="res-pop-current" class="text-white">0</span>/<span id="res-food-cap" class="text-green-500">150</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- LEFT: Tabs -->
            <section class="lg:col-span-4 space-y-6">
                <div class="warcamp-panel overflow-hidden">
                    <div class="flex border-b border-slate-700">
                        <button onclick="game.setTab('build')" id="tab-build" class="tab-btn flex-1 py-3 text-sm font-bold uppercase tracking-wider active">Logistics</button>
                        <button onclick="game.setTab('military')" id="tab-military" class="tab-btn flex-1 py-3 text-sm font-bold uppercase tracking-wider">Barracks</button>
                        <button onclick="game.setTab('spy')" id="tab-spy" class="tab-btn flex-1 py-3 text-sm font-bold uppercase tracking-wider">Espionage</button>
                        <button onclick="game.setTab('fabrial')" id="tab-fabrial" class="tab-btn flex-1 py-3 text-sm font-bold uppercase tracking-wider hidden text-purple-400">Fabrials</button>
                        <button onclick="game.setTab('arena')" id="tab-arena" class="tab-btn flex-1 py-3 text-sm font-bold uppercase tracking-wider hidden text-red-400">Arena</button>
                    </div>

                    <!-- LOGISTICS TAB -->
                    <div id="panel-build" class="p-6 space-y-4">
                        <h2 class="text-sm font-cinzel text-slate-400 mb-2">INFRASTRUCTURE</h2>
                        <div class="space-y-3 max-h-80 overflow-y-auto pr-2">
                            <!-- Black Market Unlock -->
                            <div id="black-market-option" class="hidden bg-slate-900/80 p-3 rounded border border-yellow-700/50">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="font-bold text-sm text-yellow-500">Gemheart Exchange</p>
                                    <button onclick="game.buyGemheart()" class="bg-yellow-900/40 hover:bg-yellow-800 text-yellow-200 border border-yellow-700 px-3 py-1 rounded text-[10px]">10,000 S</button>
                                </div>
                                <p class="text-[10px] text-slate-400">Purchase a Gemheart from illicit traders.</p>
                            </div>

                            <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="font-bold text-sm">Spy Network</p>
                                    <button id="btn-build-spy_network" onclick="game.build('spy_network')" class="btn-alethi px-3 py-1 rounded text-[10px]">5000 S</button>
                                </div>
                                <p class="text-[10px] text-slate-400">Unlocks Espionage Units | Owned: <span id="own-spy_network">0</span></p>
                            </div>
                            <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="font-bold text-sm">Research Library</p>
                                    <button id="btn-build-research_library" onclick="game.build('research_library')" class="btn-alethi px-3 py-1 rounded text-[10px]">10000 S</button>
                                </div>
                                <p class="text-[10px] text-slate-400">Unlocks Fabrial Technology | Owned: <span id="own-research_library">0</span></p>
                            </div>
                            <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="font-bold text-sm">Grand Market</p>
                                    <button id="btn-build-market" onclick="game.build('market')" class="btn-alethi px-3 py-1 rounded text-[10px]">250 S</button>
                                </div>
                                <p class="text-[10px] text-slate-400 font-bold text-yellow-500">+100 S/Day Income | Owned: <span id="own-market">0</span></p>
                            </div>
                            <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="font-bold text-sm">Soulcast Bunkers</p>
                                    <button id="btn-build-soulcaster" onclick="game.build('soulcaster')" class="btn-alethi px-3 py-1 rounded text-[10px]">150 S</button>
                                </div>
                                <p class="text-[10px] text-slate-400">+50 Provision Cap | Owned: <span id="own-soulcaster">0</span></p>
                            </div>
                            <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="font-bold text-sm">Military Camp</p>
                                    <button id="btn-build-training_camp" onclick="game.build('training_camp')" class="btn-alethi px-3 py-1 rounded text-[10px]">7000 S</button>
                                </div>
                                <p class="text-[10px] text-slate-400">+10% Army Power | Owned: <span id="own-training_camp">0</span></p>
                            </div>
                            <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="font-bold text-sm">Ardent Monastery</p>
                                    <button id="btn-build-monastery" onclick="game.build('monastery')" class="btn-alethi px-3 py-1 rounded text-[10px]">7000 S</button>
                                </div>
                                <p class="text-[10px] text-slate-400">+5% Survival Rate | Owned: <span id="own-monastery">0</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- BARRACKS TAB -->
                    <div id="panel-military" class="hidden p-6 space-y-4">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-sm font-cinzel text-slate-400">RECRUITMENT</h2>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-slate-500 font-bold">Bulk:</span>
                                <input type="number" id="recruit-amount" value="10" min="1" class="w-16 bg-slate-900 border border-slate-700 rounded text-center text-xs py-1 text-cyan-400 font-bold">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <button onclick="game.recruit('bridgecrews')" class="w-full btn-alethi py-2 rounded text-xs flex justify-between px-4">
                                <span>Hire Bridgecrew</span> <span>5 S</span>
                            </button>
                            <button onclick="game.recruit('spearmen')" class="w-full btn-alethi py-2 rounded text-xs flex justify-between px-4">
                                <span>Train Spearmen</span> <span>10 S</span>
                            </button>
                            <button onclick="game.recruit('archers')" class="w-full btn-alethi py-2 rounded text-xs flex justify-between px-4">
                                <span>Train Archers</span> <span>15 S</span>
                            </button>
                            <button onclick="game.recruit('chulls')" class="w-full btn-alethi py-2 rounded text-xs flex justify-between px-4">
                                <span>Purchase Chull</span> <span>50 S</span>
                            </button>
                            <button onclick="game.recruit('shardbearers')" class="w-full bg-cyan-900 border border-cyan-400 py-2 rounded text-xs flex justify-between px-4">
                                <span>Equip Shardbearer</span> <span>1 Gemheart</span>
                            </button>
                        </div>
                    </div>

                    <!-- ESPIONAGE TAB -->
                    <div id="panel-spy" class="hidden p-6 space-y-4">
                        <h2 class="text-sm font-cinzel text-slate-400 mb-2">GHOSTBLOOD OPERATIONS</h2>
                        
                        <!-- RECRUITMENT SECTION -->
                        <div id="spy-recruit-locked" class="bg-red-900/20 border border-red-900 p-4 rounded text-center">
                            <p class="text-xs text-red-400 font-bold uppercase">Network Offline</p>
                            <p class="text-[10px] text-slate-500 mt-1">Build a Spy Network in Logistics.</p>
                        </div>

                        <div id="spy-recruit-unlocked" class="hidden space-y-2 mb-4">
                            <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest border-b border-slate-800 pb-1">Recruit Agents</h3>
                            <button onclick="game.recruit('noble')" class="w-full btn-alethi py-2 rounded text-xs flex justify-between px-4">
                                <span>Lighteyes Noble (Pwr 1)</span> <span>50 S</span>
                            </button>
                            <button onclick="game.recruit('spy')" class="w-full btn-alethi py-2 rounded text-xs flex justify-between px-4">
                                <span>Undercity Spy (Pwr 2)</span> <span>150 S</span>
                            </button>
                            <button onclick="game.recruit('ghostblood')" class="w-full bg-purple-900/50 hover:bg-purple-800 border border-purple-500/30 py-2 rounded text-xs flex justify-between px-4">
                                <span>Ghostblood Agent (Pwr 5)</span> <span>600 S</span>
                            </button>
                        </div>

                        <div class="bg-slate-900/60 p-4 rounded border border-slate-700 space-y-3">
                            <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest border-b border-slate-800 pb-1">Missions</h3>
                            <select id="spy-target" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-xs">
                                <option value="sadeas">Highprince Sadeas</option>
                                <option value="vargo">Highprince Taravangian</option>
                                <option value="sebarial">Highprince Sebarial</option>
                            </select>
                            <div class="grid grid-cols-1 gap-2">
                                <button onclick="game.spyAction('intel')" class="bg-slate-700 hover:bg-slate-600 py-2 rounded text-[10px] uppercase font-bold transition-colors">Infiltrate (Intel)</button>
                                <button onclick="game.spyAction('steal_spheres')" class="bg-yellow-900/50 hover:bg-yellow-800 py-2 rounded text-[10px] uppercase font-bold transition-colors">Heist Spheres (1.5x Power)</button>
                                <button onclick="game.spyAction('steal_shards')" class="bg-cyan-900/50 hover:bg-cyan-800 py-2 rounded text-[10px] uppercase font-bold transition-colors">Seize Shards (3.0x Power)</button>
                            </div>
                        </div>
                    </div>

                    <!-- FABRIAL TAB -->
                    <div id="panel-fabrial" class="hidden p-6 space-y-4">
                        <h2 class="text-sm font-cinzel text-purple-400 mb-2 border-b border-purple-900/50 pb-2">FABRIAL ENGINEERING</h2>
                        <div class="space-y-3">
                            <!-- Heatrial -->
                            <div class="bg-purple-900/20 border border-purple-800 p-3 rounded flex justify-between items-center">
                                <div>
                                    <p class="text-xs font-bold text-purple-200">Heatrial System</p>
                                    <p class="text-[10px] text-slate-400">Increases Provision Cap by 1.5x</p>
                                </div>
                                <button id="btn-fab-heatrial" onclick="game.constructFabrial('heatrial')" class="bg-purple-700 hover:bg-purple-600 text-white text-[10px] px-3 py-2 rounded font-bold">
                                    3 Gemhearts
                                </button>
                            </div>
                            <!-- Synchronized Ledger -->
                            <div class="bg-purple-900/20 border border-purple-800 p-3 rounded flex justify-between items-center">
                                <div>
                                    <p class="text-xs font-bold text-purple-200">Synchronized Ledger</p>
                                    <p class="text-[10px] text-slate-400">Increases Market Income by 1.5x</p>
                                </div>
                                <button id="btn-fab-ledger" onclick="game.constructFabrial('ledger')" class="bg-purple-700 hover:bg-purple-600 text-white text-[10px] px-3 py-2 rounded font-bold">
                                    5 Gemhearts
                                </button>
                            </div>
                            <!-- Gravity-Spanning Rig -->
                            <div class="bg-purple-900/20 border border-purple-800 p-3 rounded flex justify-between items-center">
                                <div>
                                    <p class="text-xs font-bold text-purple-200">Gravity-Spanning Rig</p>
                                    <p class="text-[10px] text-slate-400">Increases Army Speed by 2.0x</p>
                                </div>
                                <button id="btn-fab-gravity_lift" onclick="game.constructFabrial('gravity_lift')" class="bg-purple-700 hover:bg-purple-600 text-white text-[10px] px-3 py-2 rounded font-bold">
                                    7 Gemhearts
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ARENA TAB -->
                    <div id="panel-arena" class="hidden p-6 space-y-4">
                        <div class="flex justify-between items-center border-b border-red-900 pb-2">
                            <h2 class="text-sm font-cinzel text-red-400">PROVING GROUNDS</h2>
                            <div class="text-right">
                                <p class="text-[10px] text-slate-400">Champion Level: <span id="arena-level" class="text-white font-bold">1</span></p>
                                <p class="text-[10px] text-slate-400">Health: <span id="arena-hp" class="text-green-400 font-bold">3/3</span></p>
                                <p class="text-[10px] text-slate-400">Thrill: <span id="arena-thrill" class="text-red-400 font-bold">10/10</span></p>
                                <p class="text-[10px] text-slate-400">Duels Remaining: <span id="arena-daily" class="text-cyan-400 font-bold">5/5</span></p>
                            </div>
                        </div>

                        <!-- LOBBY VIEW -->
                        <div id="arena-lobby" class="text-center space-y-4 py-8">
                            <p class="text-xs text-slate-300 italic">"Command the Thrill. Break your opponent."</p>
                            <button onclick="game.startDuel()" class="bg-red-800 hover:bg-red-700 text-white font-bold px-6 py-3 rounded border border-red-500 shadow-lg shadow-red-900/20">
                                FIND OPPONENT
                            </button>
                            
                            <!-- TOURNAMENT BUTTON (Conditional) -->
                            <div id="tournament-active" class="hidden mt-6 bg-yellow-900/30 border border-yellow-600/50 p-4 rounded text-center animate-pulse">
                                <h3 class="text-yellow-400 font-bold text-sm mb-2">MONTHLY TOURNAMENT</h3>
                                <button onclick="game.enterTournament()" class="bg-yellow-600 hover:bg-yellow-500 text-black font-bold text-xs px-6 py-2 rounded">
                                    COMPETE FOR GEMHEART
                                </button>
                            </div>
                        </div>

                        <!-- COMBAT VIEW -->
                        <div id="arena-combat" class="hidden flex flex-col h-full">
                            <div class="flex justify-between items-center bg-slate-900/50 p-2 rounded mb-4">
                                <div class="text-left">
                                    <span class="block text-xs font-bold text-blue-300">YOU</span>
                                    <span id="combat-player-hp" class="block text-[10px] text-green-400">HP: 3/3</span>
                                    <span id="combat-player-thrill" class="block text-[10px] text-red-400">Thrill: 10</span>
                                </div>
                                <div class="text-xs text-slate-500 font-bold">VS</div>
                                <div class="text-right">
                                    <span class="block text-xs font-bold text-red-300">ENEMY</span>
                                    <span id="combat-enemy-hp" class="block text-[10px] text-green-400">HP: 3/3</span>
                                    <span id="combat-enemy-thrill" class="block text-[10px] text-red-400">Thrill: 10</span>
                                </div>
                            </div>

                            <div class="flex-grow bg-black/30 p-2 rounded mb-4 h-32 overflow-y-auto text-[10px] font-mono border border-slate-800" id="combat-log">
                                <p class="text-slate-500">Duel started. Commit your Thrill...</p>
                            </div>

                            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                                <label class="block text-[10px] text-slate-400 mb-1">Push Amount:</label>
                                <div class="flex gap-2">
                                    <input type="number" id="thrill-input" min="0" value="1" class="bg-black border border-slate-600 rounded px-2 py-1 text-white text-sm w-16 text-center">
                                    <button onclick="game.commitThrill()" class="flex-grow bg-red-700 hover:bg-red-600 text-white font-bold text-xs rounded uppercase tracking-wider">
                                        PUSH
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- MILITARY DETAILS PANEL -->
                <div class="warcamp-panel p-6">
                    <h2 class="text-sm font-cinzel text-slate-400 mb-4 border-b border-slate-700 pb-2">MILITARY STRENGTH</h2>
                    <div class="grid grid-cols-2 gap-3 text-xs mb-4">
                        <div class="stat-card"><span class="text-slate-400">Defense:</span> <span id="stat-power" class="font-bold text-white">0</span></div>
                        <div class="stat-card"><span class="text-slate-400">Available:</span> <span id="stat-avail" class="font-bold text-green-400">0</span></div>
                        <div class="stat-card"><span class="text-slate-400">Speed Mod:</span> <span id="stat-speed" class="font-bold text-white">0%</span></div>
                        <div class="stat-card"><span class="text-slate-400">Spy Power:</span> <span id="stat-agents" class="font-bold text-cyan-400">0</span></div>
                    </div>
                    
                    <div class="space-y-1 max-h-48 overflow-y-auto pr-2">
                        <div class="flex justify-between text-[11px] border-b border-slate-800 pb-1">
                            <span class="text-slate-400">Bridgecrews</span> <span id="det-bridgecrews">0</span>
                        </div>
                        <div class="flex justify-between text-[11px] border-b border-slate-800 pb-1">
                            <span class="text-slate-400">Spearmen</span> <span id="det-spearmen">0</span>
                        </div>
                        <div class="flex justify-between text-[11px] border-b border-slate-800 pb-1">
                            <span class="text-slate-400">Archers</span> <span id="det-archers">0</span>
                        </div>
                        <div class="flex justify-between text-[11px] border-b border-slate-800 pb-1">
                            <span class="text-slate-400">Spies (Total)</span> <span id="det-spies-total" class="text-purple-400">0</span>
                        </div>
                        <div class="flex justify-between text-[11px]">
                            <span class="text-slate-400">Shardbearers</span> <span id="det-shardbearers" class="text-cyan-400">0</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CENTER: Mission -->
            <section class="lg:col-span-5 space-y-6">
                <div class="warcamp-panel p-6 h-full flex flex-col">
                    <h2 class="text-xl font-bold mb-4 border-b border-slate-700 pb-2">üèúÔ∏è SHATTERED PLAINS</h2>
                    
                    <div id="mission-ui" class="flex-grow flex flex-col relative">
                        
                        <!-- NEW MISSIONS MENU -->
                        <div id="active-deployments" class="mb-4 space-y-2">
                            <!-- Populated by JS -->
                        </div>

                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <button onclick="game.openDeployModal('scout')" class="bg-slate-700 hover:bg-slate-600 p-3 rounded text-left border border-slate-600">
                                <span class="block text-xs font-bold text-slate-200">Scouting Expedition</span>
                                <span class="block text-[10px] text-slate-400">Duration: 3 Days</span>
                            </button>
                            <button onclick="game.openDeployModal('attack')" class="bg-red-900/40 hover:bg-red-900/60 p-3 rounded text-left border border-red-900/50">
                                <span class="block text-xs font-bold text-red-300">Attack Parshendi</span>
                                <span class="block text-[10px] text-red-400">High Risk | Chance: Gemheart</span>
                            </button>
                        </div>

                        <!-- PLATEAU RUN EVENT -->
                        <div id="plateau-event-container" class="hidden bg-slate-900/80 p-4 rounded-lg border border-orange-500/50 mb-4 relative overflow-hidden">
                            <div id="plateau-label" class="absolute top-0 right-0 bg-orange-600 text-[10px] font-bold px-2 py-1">WARNING</div>
                            <h3 class="text-lg font-bold text-orange-400 mb-1">PLATEAU RUN DETECTED</h3>
                            <p id="plateau-timer" class="text-2xl font-bold text-white text-center my-4">00:30</p>
                            
                            <div id="plateau-actions" class="hidden">
                                <p class="text-xs text-center text-slate-300 mb-2">Coalition forming. Muster your forces.</p>
                                <button id="btn-muster" onclick="game.openDeployModal('run')" class="w-full btn-alethi py-3 rounded font-bold text-sm mb-2">
                                    MUSTER FORCES
                                </button>
                            </div>

                            <!-- LEADERBOARD (MUSTER PHASE) -->
                            <div id="muster-leaderboard" class="hidden mt-4 border-t border-slate-700 pt-2">
                                <h4 class="text-[10px] font-bold text-slate-400 mb-1">PROJECTED SPEEDS</h4>
                                <div id="leaderboard-content" class="space-y-1"></div>
                            </div>
                        </div>

                        <div id="game-log" class="h-32 overflow-y-auto bg-black/30 p-4 rounded text-[11px] font-mono mt-auto border border-slate-800">
                            <div class="log-entry">System offline. Please authenticate.</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- RIGHT: Interactions -->
            <section class="lg:col-span-3 space-y-6">
                <div class="warcamp-panel p-6 h-64 flex flex-col">
                    <h2 class="text-sm font-cinzel text-slate-400 mb-4 border-b border-slate-700 pb-2">SPANREED</h2>
                    <div id="chat-box" class="flex-grow overflow-y-auto text-[11px] space-y-2 mb-4">
                        <p><b class="text-blue-400">Dalinar:</b> Watch your flanks. The Parshendi are probing our lines.</p>
                    </div>
                    <div class="flex gap-2">
                        <input id="chat-input" type="text" class="bg-slate-800 border-none rounded px-2 py-1 flex-grow text-[11px]" placeholder="Message...">
                        <button onclick="game.sendChat()" class="btn-alethi px-2 py-1 rounded text-[11px]">Send</button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- DEPLOYMENT MODAL -->
    <div id="deploy-modal" class="modal">
        <div class="bg-slate-900 border border-slate-600 rounded-lg p-6 w-96 max-w-full m-4 shadow-2xl">
            <h2 class="text-lg font-bold text-white mb-4 border-b border-slate-700 pb-2">MUSTER FORCES</h2>
            <p id="deploy-type-label" class="text-xs text-cyan-400 mb-4 uppercase tracking-widest"></p>
            
            <div class="space-y-3 mb-6">
                <div class="flex justify-between items-center text-[10px] text-slate-400 italic">
                    <span>Unit Type</span>
                    <span>Available / Total</span>
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-xs text-slate-300">Bridgecrews</label>
                    <div class="flex items-center gap-2">
                        <span id="avail-modal-bridgecrews" class="text-xs text-slate-500">0/0</span>
                        <input type="number" id="deploy-bridgecrews" min="0" value="0" class="w-20 bg-black border border-slate-700 rounded px-2 py-1 text-right text-sm text-white">
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-xs text-slate-300">Spearmen</label>
                    <div class="flex items-center gap-2">
                        <span id="avail-modal-spearmen" class="text-xs text-slate-500">0/0</span>
                        <input type="number" id="deploy-spearmen" min="0" value="0" class="w-20 bg-black border border-slate-700 rounded px-2 py-1 text-right text-sm text-white">
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-xs text-slate-300">Archers</label>
                    <div class="flex items-center gap-2">
                        <span id="avail-modal-archers" class="text-xs text-slate-500">0/0</span>
                        <input type="number" id="deploy-archers" min="0" value="0" class="w-20 bg-black border border-slate-700 rounded px-2 py-1 text-right text-sm text-white">
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-xs text-slate-300">Shardbearers</label>
                    <div class="flex items-center gap-2">
                        <span id="avail-modal-shardbearers" class="text-xs text-slate-500">0/0</span>
                        <input type="number" id="deploy-shardbearers" min="0" value="0" class="w-20 bg-black border border-slate-700 rounded px-2 py-1 text-right text-sm text-white">
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-xs text-slate-300">Chulls</label>
                    <div class="flex items-center gap-2">
                        <span id="avail-modal-chulls" class="text-xs text-slate-500">0/0</span>
                        <input type="number" id="deploy-chulls" min="0" value="0" class="w-20 bg-black border border-slate-700 rounded px-2 py-1 text-right text-sm text-white">
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="game.closeDeployModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-xs py-2 rounded font-bold">CANCEL</button>
                <button onclick="game.confirmDeploy()" class="flex-1 btn-alethi text-xs py-2 rounded font-bold">DEPLOY ARMY</button>
            </div>
        </div>
    </div>

    <script>
        const game = {
            username: null,
            state: {
                spheres: 15000, 
                gemhearts: 0,
                military: {
                    bridgecrews: 20, spearmen: 100, archers: 0,
                    shardbearers: 0, chulls: 0,
                    noble: 0, spy: 0, ghostblood: 0
                },
                arena: {
                    level: 1,
                    xp: 0,
                    hp: 3,
                    maxHp: 3,
                    maxThrill: 10,
                    wins: 0,
                    dailyDuels: 0
                },
                tournamentActive: false,
                activeDuel: null, 
                deployments: [], 
                buildings: { 
                    soulcaster: 0, market: 0, training_camp: 0,
                    monastery: 0, shelter: 0, spy_network: 0, research_library: 0
                },
                fabrials: {
                    heatrial: false,
                    ledger: false,
                    gravity_lift: false
                },
                startTime: Date.now(),
                lastTickTime: Date.now(),
                activeRun: null, 
                pendingDeployType: null
            },

            npcPrinces: {
                sadeas:   { name: "Sadeas", agents: 15, spheres: 15000, shardbearers: 2, power: 150, bridgecrews: 40 },
                vargo:    { name: "Taravangian", agents: 50, spheres: 5000, shardbearers: 0, power: 40, bridgecrews: 10 },
                sebarial: { name: "Sebarial", agents: 10, spheres: 80000, shardbearers: 0, power: 20, bridgecrews: 5 },
                dalinar:  { name: "Dalinar", agents: 20, spheres: 5000, shardbearers: 1, power: 120, bridgecrews: 20 }
            },

            unitStats: {
                bridgecrews: { power: 0.1, survival: 0.1, carry: 5, speed: 0.01, cost: 5 }, 
                spearmen:    { power: 1, survival: 0.7, carry: 10, speed: 0, cost: 10 },
                archers:     { power: 1, survival: 0.9, carry: 10, speed: 0, cost: 15 },
                chulls:      { power: 0.5, survival: 0.8, carry: 100, speed: -0.025, cost: 50 }, 
                shardbearers:{ power: 0, survival: 1.0, carry: 20, speed: 0, multiplier: 2.0, cost: 0 },
                noble:       { power: 0, survival: 0.5, cost: 50, spy: 1 },
                spy:         { power: 0, survival: 0.7, cost: 150, spy: 2 },
                ghostblood:  { power: 0, survival: 0.9, cost: 600, spy: 5 }
            },

            buildingData: {
                soulcaster:    { baseCost: 150, cap: 50, income: 0, powerMod: 0, survivalMod: 0, scale: 'exponential' },
                market:        { baseCost: 250, cap: 0, income: 100, powerMod: 0, survivalMod: 0, scale: 'exponential' },
                training_camp: { baseCost: 7000, cap: 0, income: 0, powerMod: 0.1, survivalMod: 0, scale: 'linear' },
                monastery:     { baseCost: 7000, cap: 0, income: 0, powerMod: 0, survivalMod: 0.05, scale: 'linear' },
                spy_network:   { baseCost: 5000, cap: 0, income: 0, powerMod: 0, survivalMod: 0, max: 1 },
                research_library: { baseCost: 10000, cap: 0, income: 0, powerMod: 0, survivalMod: 0, max: 1 },
                shelter:       { baseCost: 100, cap: 10, income: 0, powerMod: 0, survivalMod: 0 } 
            },

            fabrialData: {
                heatrial: { cost: 3, name: "Heatrial System" },
                ledger: { cost: 5, name: "Synchronized Ledger" },
                gravity_lift: { cost: 7, name: "Gravity-Spanning Rig" }
            },

            constants: {
                DAY_MS: 3600000, // 1 Hour in ms
                UI_UPDATE_RATE: 1000 
            },

            // INIT NO LONGER LOADS GAME. LOGIN DOES.
            init() {
                // Wait for login
                document.getElementById('username-input').addEventListener('keypress', (e) => {
                    if(e.key === 'Enter') this.login();
                });
            },

            login() {
                const input = document.getElementById('username-input');
                const name = input.value.trim();
                if(!name) return;

                this.username = name;
                document.getElementById('player-name-display').innerText = name;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('game-container').classList.remove('hidden');

                this.loadGame(); // Load data specific to this user
                this.processOfflineTime();
                this.updateUI();
                setInterval(() => this.loop(), this.constants.UI_UPDATE_RATE);
                
                this.log(`Welcome, Highprince ${name}. Warcamp Command online.`, "text-cyan-400 font-bold");
            },

            processOfflineTime() {
                const now = Date.now();
                const elapsed = now - this.state.lastTickTime;
                
                if(elapsed >= this.constants.DAY_MS) {
                     const daysPassed = Math.floor(elapsed / this.constants.DAY_MS);
                     this.processDailyTicks(daysPassed);
                     this.state.lastTickTime = now;
                     this.log(`Offline for ${daysPassed} days. Resources updated.`, "text-cyan-400");
                }
            },

            loop() {
                const now = Date.now();
                if (now - this.state.lastTickTime >= this.constants.DAY_MS) {
                    this.processDailyTicks(1);
                    this.state.lastTickTime = now;
                    this.saveGame();
                }

                if (this.state.activeRun) {
                    const run = this.state.activeRun;
                    if (run.phase === 'WARNING') {
                        const timeLeft = (run.warnEndTime - now) / 1000;
                        document.getElementById('plateau-timer').innerText = `WARNING: ${timeLeft.toFixed(1)}s`;
                        if (now >= run.warnEndTime) {
                            run.phase = 'OPEN';
                            run.openEndTime = now + this.constants.DAY_MS; 
                            document.getElementById('plateau-label').innerText = "MUSTER PHASE";
                            document.getElementById('plateau-label').className = "absolute top-0 right-0 bg-green-600 text-[10px] font-bold px-2 py-1";
                            document.getElementById('plateau-actions').classList.remove('hidden');
                            document.getElementById('muster-leaderboard').classList.remove('hidden');
                            this.updateRunButtonState(); 
                        }
                    } else if (run.phase === 'OPEN') {
                        const timeLeft = (run.openEndTime - now) / 1000;
                        
                        const hrs = Math.floor(timeLeft / 3600);
                        const mins = Math.floor((timeLeft % 3600) / 60);
                        document.getElementById('plateau-timer').innerText = `Departing: ${hrs}h ${mins}m`;
                        
                        if (Math.random() < 0.05) this.simulateNPCJoin(); 
                        if (now >= run.openEndTime) {
                            this.resolveRun();
                        }
                    }
                }

                this.checkDeployments();
                this.updateUI();
            },

            processDailyTicks(count) {
                for (let i = 0; i < count; i++) {
                    this.state.spheres += (this.state.gemhearts * 20);
                    
                    let income = this.state.buildings.market * this.buildingData.market.income;
                    if (this.state.fabrials.ledger) income *= 1.5;
                    this.state.spheres += income;
                    
                    this.state.arena.dailyDuels = 0;
                    if (this.state.arena.hp <= 0) {
                         this.state.arena.hp = this.state.arena.maxHp;
                         this.log("A new day! Your champion has recovered.", "text-green-400");
                    }
                    
                    if (!this.state.activeRun && Math.random() < 0.1) {
                        this.spawnEvent();
                    }

                    if (Math.random() < 0.14) {
                        this.triggerDefenseEvent();
                    }

                    // Tournament check
                    const totalDays = Math.floor((Date.now() - this.state.startTime) / this.constants.DAY_MS);
                    const dayOfMonth = (totalDays % 24) + 1;
                    if (dayOfMonth === 24 && !this.state.tournamentActive) {
                        this.state.tournamentActive = true;
                        this.log("Tournament of Highprinces has begun!", "text-yellow-400 font-bold");
                    } else if (dayOfMonth !== 24) {
                        this.state.tournamentActive = false;
                    }
                }
            },

            triggerDefenseEvent() {
                const screen = document.getElementById('screen-overlay');
                screen.classList.add('alert-flash');
                setTimeout(() => screen.classList.remove('alert-flash'), 4000);

                const attackPower = 20 + Math.floor(Math.random() * 100);
                const defenseStats = this.getArmyStats(true); 
                const defensePower = defenseStats.power;

                this.log(`ATTACK! Parshendi raiding party detected (Power: ${attackPower}).`, "text-red-500 font-bold bg-red-900/20 border-l-4 border-red-600 pl-2");

                if (defensePower >= attackPower) {
                    this.log(`DEFENSE SUCCESSFUL. Your garrison (${defensePower.toFixed(0)}) repelled the raid.`, "text-green-400");
                } else {
                    let lossMsg = "DEFENSES BREACHED. ";
                    if (this.state.spheres > 0) {
                        const lostSpheres = Math.floor(this.state.spheres * 0.2);
                        this.state.spheres -= lostSpheres;
                        lossMsg += `Lost ${lostSpheres} Spheres. `;
                    }
                    if (this.state.gemhearts > 0 && Math.random() < 0.5) {
                        this.state.gemhearts--;
                        lossMsg += `A Gemheart was stolen! `;
                    }
                    const avail = this.getAvailableTroops();
                    this.processCasualties(avail, 0.2);
                    this.log(lossMsg, "text-orange-500");
                }
            },

            spawnEvent() {
                const now = Date.now();
                this.state.activeRun = {
                    id: Math.floor(Math.random() * 999),
                    phase: 'WARNING',
                    warnEndTime: now + 30000, 
                    difficulty: Math.random() > 0.5 ? 'Medium' : 'Hard',
                    enemyPower: 50 + Math.floor(Math.random() * 100),
                    participants: [],
                    playerForces: null 
                };
                
                document.getElementById('plateau-event-container').classList.remove('hidden');
                document.getElementById('screen-overlay').classList.add('warn-flash');
                setTimeout(() => document.getElementById('screen-overlay').classList.remove('warn-flash'), 2000);
                this.log(`SCOUT REPORT: Chasmfiend spotted! 30 seconds to muster.`, "text-orange-400 font-bold");
                
                this.simulateNPCJoin(true);
            },

            simulateNPCJoin(force = false) {
                if (!this.state.activeRun) return;
                
                const availableNPCs = Object.values(this.npcPrinces).filter(n => 
                    !this.state.activeRun.participants.find(p => p.name === n.name)
                );

                if (availableNPCs.length === 0) return;

                const npc = availableNPCs[Math.floor(Math.random() * availableNPCs.length)];
                const npcSpeed = 1.0 + (npc.bridgecrews * 0.01);

                this.state.activeRun.participants.push({
                    name: npc.name,
                    power: npc.power,
                    speed: npcSpeed,
                    isPlayer: false
                });
                
                if(document.getElementById('muster-leaderboard').offsetParent !== null) {
                    this.updateEventUI();
                }
            },

            openDeployModal(type) {
                if (type === 'run') {
                    if(!this.state.activeRun || this.state.activeRun.phase !== 'OPEN') {
                        this.log("Deployment window is closed.", "text-red-400");
                        return;
                    }
                    if(this.state.activeRun.playerForces) {
                        this.log("You have already committed forces to this run.", "text-yellow-400");
                        return;
                    }
                }
                
                this.state.pendingDeployType = type;
                const avail = this.getAvailableTroops();
                
                ['bridgecrews', 'spearmen', 'archers', 'shardbearers', 'chulls'].forEach(u => {
                    const total = this.state.military[u];
                    const available = avail[u] || 0;
                    document.getElementById(`avail-modal-${u}`).innerText = `${available}/${total}`;
                    const input = document.getElementById(`deploy-${u}`);
                    input.max = available;
                    input.value = 0;
                });

                document.getElementById('deploy-type-label').innerText = type === 'run' ? "PLATEAU RUN FORCE" : (type === 'scout' ? "SCOUTING PARTY" : "RAIDING WARBAND");
                document.getElementById('deploy-modal').classList.add('open');
            },

            closeDeployModal() {
                document.getElementById('deploy-modal').classList.remove('open');
            },

            confirmDeploy() {
                const units = {};
                let total = 0;
                ['bridgecrews', 'spearmen', 'archers', 'shardbearers', 'chulls'].forEach(u => {
                    const val = parseInt(document.getElementById(`deploy-${u}`).value) || 0;
                    units[u] = val;
                    total += val;
                });

                if (total === 0) {
                    this.log("You must assign at least one unit.", "text-red-400");
                    return;
                }

                const avail = this.getAvailableTroops();
                for (let u in units) {
                    if (units[u] > (avail[u] || 0)) {
                        this.log(`Not enough ${u} available!`, "text-red-400");
                        return;
                    }
                }

                // Calculate Speed for ALL missions
                let power = 0;
                let speed = 1.0;
                for(let u in units) {
                    const s = this.unitStats[u];
                    power += units[u] * s.power;
                    if(s.multiplier) power *= (s.multiplier * units[u]);
                    speed += (units[u] * s.speed); 
                }
                if (this.state.fabrials.gravity_lift) speed *= 2.0;
                speed = Math.max(0.1, speed);

                if (this.state.pendingDeployType === 'run' && this.state.activeRun) {
                    this.state.activeRun.playerForces = { units, power, speed };
                    this.state.activeRun.participants.push({
                        name: "You",
                        power: power,
                        speed: speed,
                        isPlayer: true
                    });

                    this.updateRunButtonState();
                    this.log(`Forces committed. Speed Rating: ${(speed*100).toFixed(0)}%.`, "text-cyan-400");
                    this.closeDeployModal();
                    return;
                }

                // Standard Deployments
                const baseDays = this.state.pendingDeployType === 'scout' ? 3 : 2;
                const durationMs = (baseDays * this.constants.DAY_MS) / speed;
                
                const deployment = {
                    id: Date.now(),
                    type: this.state.pendingDeployType,
                    units: units,
                    returnTime: Date.now() + durationMs,
                    startDay: new Date().toLocaleTimeString()
                };

                this.state.deployments.push(deployment);
                const actualHours = (durationMs / 3600000).toFixed(1);
                this.log(`Army deployed for ${this.state.pendingDeployType}. Speed: ${(speed*100).toFixed(0)}%. Return: ${actualHours} hrs.`, "text-blue-400");
                this.closeDeployModal();
                this.updateUI();
            },

            updateRunButtonState() {
                const btn = document.getElementById('btn-muster');
                const actions = document.getElementById('plateau-actions');
                if (this.state.activeRun && this.state.activeRun.playerForces) {
                    actions.innerHTML = `<p class="text-green-400 font-bold text-center text-xs border border-green-900 bg-green-900/20 p-2 rounded">FORCES COMMITTED</p>`;
                } else if (this.state.activeRun) {
                    // Reset if new run
                    actions.innerHTML = `
                        <p class="text-xs text-center text-slate-300 mb-2">Coalition forming. Muster your forces.</p>
                        <button id="btn-muster" onclick="game.openDeployModal('run')" class="w-full btn-alethi py-3 rounded font-bold text-sm mb-2">
                            MUSTER FORCES
                        </button>
                    `;
                }
            },

            resolveRun() {
                const run = this.state.activeRun;
                this.state.activeRun = null;
                document.getElementById('plateau-event-container').classList.add('hidden');
                document.getElementById('muster-leaderboard').classList.add('hidden');
                
                const totalAlliedPower = run.participants.reduce((acc, p) => acc + p.power, 0);
                const victory = totalAlliedPower >= run.enemyPower;

                const sortedParticipants = run.participants.sort((a, b) => b.speed - a.speed);
                const gemheartWinner = sortedParticipants[0];

                const result = {
                    victory: victory,
                    totalPower: totalAlliedPower,
                    enemyPower: run.enemyPower,
                    gemheartWon: victory && gemheartWinner.isPlayer,
                    gemheartWinnerName: victory ? gemheartWinner.name : null,
                    lootShare: 0
                };

                if (victory && run.playerForces) {
                    const totalLoot = Math.floor(Math.random() * 50000) + 25000;
                    
                    let potentialShare = (run.playerForces.power / totalAlliedPower) * totalLoot;
                    let carryCap = 0;
                    for(let u in run.playerForces.units) {
                        carryCap += run.playerForces.units[u] * this.unitStats[u].carry;
                    }

                    result.lootShare = Math.floor(Math.min(potentialShare, carryCap));
                }

                this.log("The Coalition has departed for the Plateau.", "text-slate-400 italic");

                if (run.playerForces) {
                    const durationMs = 2 * this.constants.DAY_MS;
                    this.state.deployments.push({
                        id: Date.now(),
                        type: 'run',
                        units: run.playerForces.units,
                        returnTime: Date.now() + durationMs, 
                        runResult: result 
                    });
                } else {
                    if (victory) this.log(`News: The Coalition defeated the Parshendi. ${gemheartWinner.name} took the Gemheart.`, "text-slate-500");
                    else this.log(`News: The Coalition was defeated.`, "text-red-900");
                }
                
                this.saveGame();
            },

            checkDeployments() {
                const now = Date.now();
                const finished = this.state.deployments.filter(d => now >= d.returnTime);
                this.state.deployments = this.state.deployments.filter(d => now < d.returnTime);

                finished.forEach(d => {
                    this.resolveMission(d);
                });
            },

            resolveMission(deployment) {
                let power = 0;
                let carry = 0;
                for (let u in deployment.units) {
                    const count = deployment.units[u];
                    const stats = this.unitStats[u];
                    power += count * stats.power;
                    carry += count * stats.carry;
                    if(stats.multiplier && count > 0) power *= (stats.multiplier * count);
                }

                if (deployment.type === 'run') {
                    const res = deployment.runResult;
                    if (res.victory) {
                        this.log(`CAMPAIGN VICTORY! Coalition Power ${Math.floor(res.totalPower)} crushed ${res.enemyPower}.`, "text-green-400 font-bold");
                        
                        if (res.gemheartWon) {
                            this.state.gemhearts++;
                            this.log(`GEMHEART SECURED! Your army was the fastest.`, "text-cyan-400 font-bold border-l-4 border-cyan-400 pl-2");
                        } else {
                            this.log(`${res.gemheartWinnerName} secured the Gemheart before you arrived.`, "text-yellow-500");
                        }

                        this.state.spheres += res.lootShare;
                        this.log(`You returned with ${res.lootShare.toLocaleString()} spheres.`, "text-slate-300");
                    } else {
                        this.log(`CAMPAIGN DEFEAT. The Parshendi (${res.enemyPower}) held the plateau.`, "text-red-500 font-bold");
                        this.processCasualties(deployment.units, 0.3); 
                        this.log("Heavy casualties sustained in the rout.", "text-orange-500");
                    }
                    return; 
                }

                if (deployment.type === 'scout') {
                    if (Math.random() > 0.1) {
                        const spheres = Math.floor(Math.random() * 300);
                        this.state.spheres += spheres;
                        this.log(`Scouts returned with ${spheres} spheres.`, "text-green-300");
                    } else {
                        this.log("Scouting party lost.", "text-red-500");
                        this.processCasualties(deployment.units, 1.0);
                    }
                } else if (deployment.type === 'attack') {
                    const enemyPower = 50 + Math.floor(Math.random() * 50);
                    if (power > enemyPower) {
                        const spheres = Math.min(carry, 2000);
                        this.state.spheres += spheres;
                        let msg = `Raid successful! Looted ${spheres} spheres.`;
                        if (Math.random() < 0.15) {
                            this.state.gemhearts++;
                            msg += " AND A GEMHEART!";
                        }
                        this.log(msg, "text-cyan-400 font-bold");
                        this.processCasualties(deployment.units, 0.1);
                    } else {
                        this.log("Raid failed.", "text-red-500");
                        this.processCasualties(deployment.units, 0.5);
                    }
                }
            },

            processCasualties(units, baseRate) {
                for (let u in units) {
                    const count = units[u];
                    let lost = 0;
                    
                    let effectiveRate = baseRate;
                    if (u === 'shardbearers') effectiveRate = 0.005;
                    if (u === 'bridgecrews') effectiveRate = 0.9;

                    for(let i=0; i<count; i++) { if(Math.random() < effectiveRate) lost++; }
                    
                    this.state.military[u] = Math.max(0, this.state.military[u] - lost);
                    if (lost > 0 && u === 'shardbearers') {
                        this.log("A SHARDBEARER HAS FALLEN!", "text-red-600 font-bold bg-red-950 p-1 border border-red-500");
                    }
                }
            },

            getAvailableTroops() {
                const avail = { ...this.state.military };
                this.state.deployments.forEach(d => {
                    for (let u in d.units) { if (avail[u]) avail[u] -= d.units[u]; }
                });
                if (this.state.activeRun && this.state.activeRun.playerForces) {
                    const committed = this.state.activeRun.playerForces.units;
                    for (let u in committed) { if (avail[u]) avail[u] -= committed[u]; }
                }
                return avail;
            },

            getArmyStats(availableOnly = false) {
                let basePower = 0; let totalCarry = 0; let speedMod = 1.0; let unitMultiplier = 1.0; let currentPop = 0;
                let counts = availableOnly ? this.getAvailableTroops() : this.state.military;
                for (const [unit, count] of Object.entries(counts)) {
                    if (this.unitStats[unit]) {
                        const stats = this.unitStats[unit];
                        if (!stats.spy) {
                            currentPop += count;
                            basePower += count * stats.power;
                            totalCarry += count * stats.carry;
                            speedMod += count * stats.speed;
                            if (stats.multiplier) { for(let i=0; i<count; i++) unitMultiplier *= stats.multiplier; }
                        } else { currentPop += count; }
                    }
                }
                const trainingBonus = 1 + (this.state.buildings.training_camp * this.buildingData.training_camp.powerMod);
                const survivalBonus = (this.state.buildings.monastery * this.buildingData.monastery.survivalMod);
                let provisionCap = 150 + (this.state.buildings.soulcaster * 50); // UPDATED BASE CAP
                if (this.state.fabrials.heatrial) provisionCap *= 1.5;
                
                return { power: basePower * unitMultiplier * trainingBonus, carry: totalCarry, speed: Math.max(0.1, speedMod), pop: currentPop, cap: Math.floor(provisionCap), survivalBonus: survivalBonus };
            },
            getSpyPower() {
                let power = 0;
                if (this.state.military.noble) power += this.state.military.noble * this.unitStats.noble.spy;
                if (this.state.military.spy) power += this.state.military.spy * this.unitStats.spy.spy;
                if (this.state.military.ghostblood) power += this.state.military.ghostblood * this.unitStats.ghostblood.spy;
                return power;
            },
            
            getBuildingCost(type) {
                const data = this.buildingData[type];
                if (!data) return 0;
                if (data.scale === 'exponential') {
                    const owned = this.state.buildings[type] || 0;
                    return data.baseCost * Math.pow(2, Math.floor(owned / 10));
                }
                if (data.scale === 'linear') {
                    const owned = this.state.buildings[type] || 0;
                    return data.baseCost + (owned * 5000);
                }
                return data.baseCost;
            },

            updateUI() {
                this.updateTimeUI();
                const stats = this.getArmyStats(false); 
                const availStats = this.getArmyStats(true); 
                const availTroops = this.getAvailableTroops();
                const spyPower = this.getSpyPower();
                
                document.getElementById('res-spheres').innerText = Math.floor(this.state.spheres).toLocaleString();
                document.getElementById('res-gemhearts').innerText = this.state.gemhearts;
                document.getElementById('res-pop-current').innerText = stats.pop; 
                document.getElementById('res-food-cap').innerText = stats.cap;
                document.getElementById('stat-power').innerText = Math.floor(availStats.power);
                document.getElementById('stat-avail').innerText = availStats.pop; 
                document.getElementById('stat-speed').innerText = Math.round((stats.speed - 1) * 100) + "%";
                document.getElementById('stat-agents').innerText = spyPower;
                document.getElementById('arena-daily').innerText = `${5 - this.state.arena.dailyDuels}/5`;
                
                for (const unit in this.state.military) {
                    const el = document.getElementById('det-' + unit);
                    if (el) { const tot = this.state.military[unit]; const av = availTroops[unit]; el.innerText = `${av}/${tot}`; }
                }
                const totalSpies = (this.state.military.noble || 0) + (this.state.military.spy || 0) + (this.state.military.ghostblood || 0);
                const spyEl = document.getElementById('det-spies-total');
                if(spyEl) spyEl.innerText = totalSpies;
                
                // Arena & Black Market Logic (RESTORED)
                if (this.state.military.shardbearers > 0) {
                    document.getElementById('tab-arena').classList.remove('hidden');
                } else {
                    document.getElementById('tab-arena').classList.add('hidden');
                }

                if (this.state.buildings.market >= 30) {
                    document.getElementById('black-market-option').classList.remove('hidden');
                } else {
                    document.getElementById('black-market-option').classList.add('hidden');
                }
                
                // Update Buildings Buttons
                for (const bld in this.state.buildings) {
                    const el = document.getElementById('own-' + bld);
                    if (el) el.innerText = this.state.buildings[bld];
                    
                    const btn = document.getElementById('btn-build-' + bld);
                    if (btn) {
                        const data = this.buildingData[bld];
                        const owned = this.state.buildings[bld];
                        if (data.max && owned >= data.max) {
                            btn.innerText = "MAX";
                            btn.disabled = true;
                            btn.classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            const cost = this.getBuildingCost(bld);
                            btn.innerText = `${cost.toLocaleString()} S`;
                            btn.disabled = this.state.spheres < cost;
                            if (this.state.spheres < cost) btn.classList.add('opacity-50', 'cursor-not-allowed');
                            else btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                }

                if (this.state.buildings.spy_network > 0) {
                    document.getElementById('spy-recruit-locked').classList.add('hidden');
                    document.getElementById('spy-recruit-unlocked').classList.remove('hidden');
                } else {
                    document.getElementById('spy-recruit-locked').classList.remove('hidden');
                    document.getElementById('spy-recruit-unlocked').classList.add('hidden');
                }

                if (this.state.buildings.research_library > 0) {
                    document.getElementById('tab-fabrial').classList.remove('hidden');
                } else {
                    document.getElementById('tab-fabrial').classList.add('hidden');
                }

                for (let fab in this.state.fabrials) {
                    const btn = document.getElementById('btn-fab-' + fab);
                    if (btn) {
                        if (this.state.fabrials[fab]) {
                            btn.innerText = "OWNED";
                            btn.disabled = true;
                            btn.classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            const cost = this.fabrialData[fab].cost;
                            btn.disabled = this.state.gemhearts < cost;
                            if (this.state.gemhearts < cost) btn.classList.add('opacity-50', 'cursor-not-allowed');
                            else btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                }
                
                document.getElementById('arena-level').innerText = this.state.arena.level;
                document.getElementById('arena-hp').innerText = `${this.state.arena.hp}/${this.state.arena.maxHp}`;
                
                if (this.state.tournamentActive) {
                    document.getElementById('tournament-active').classList.remove('hidden');
                    if (document.getElementById('arena-lobby')) {
                         document.getElementById('arena-lobby').classList.add('opacity-50');
                    }
                } else {
                    document.getElementById('tournament-active').classList.add('hidden');
                    if (document.getElementById('arena-lobby')) {
                         document.getElementById('arena-lobby').classList.remove('opacity-50');
                    }
                }

                const depList = document.getElementById('active-deployments');
                depList.innerHTML = '';
                if (this.state.deployments.length === 0) {
                    depList.innerHTML = '<p class="text-xs text-slate-500 italic text-center">No active missions.</p>';
                } else {
                    this.state.deployments.forEach(d => {
                        const timeLeft = Math.max(0, (d.returnTime - Date.now()) / 1000).toFixed(0);
                        
                        // Human readable format for missions
                        const hrs = Math.floor(timeLeft / 3600);
                        const mins = Math.floor((timeLeft % 3600) / 60);
                        const secs = Math.floor(timeLeft % 60);
                        
                        let timeStr = `${secs}s`;
                        if (hrs > 0) timeStr = `${hrs}h ${mins}m`;
                        else if (mins > 0) timeStr = `${mins}m ${secs}s`;

                        const div = document.createElement('div');
                        div.className = "bg-blue-900/30 border border-blue-800 p-2 rounded flex justify-between items-center text-[10px]";
                        div.innerHTML = `<div><span class="font-bold text-cyan-300 uppercase">${d.type}</span><span class="text-slate-400 block">Returns: ${timeStr}</span></div><div class="text-right"><span class="block">Units: ${Object.values(d.units).reduce((a,b)=>a+b,0)}</span></div>`;
                        depList.appendChild(div);
                    });
                }
            },
            build(type) {
                const data = this.buildingData[type];
                if (!data) return;
                
                if (data.max && this.state.buildings[type] >= data.max) return;

                const cost = this.getBuildingCost(type);
                
                if (this.state.spheres >= cost) {
                    this.state.spheres -= cost;
                    this.state.buildings[type]++;
                    this.log(`Constructed ${type.replace('_', ' ')}.`, "text-green-400 text-xs");
                    this.saveGame();
                    this.updateUI();
                }
            },
            buyGemheart() {
                if (this.state.spheres >= 10000) {
                    this.state.spheres -= 10000;
                    this.state.gemhearts++;
                    this.log("Purchased a Gemheart from the black market.", "text-yellow-400 font-bold");
                    this.saveGame();
                    this.updateUI();
                } else {
                    this.log("Insufficient spheres for Gemheart purchase.", "text-red-400");
                }
            },
            constructFabrial(type) {
                const data = this.fabrialData[type];
                if (this.state.fabrials[type]) return;

                if (this.state.gemhearts >= data.cost) {
                    this.state.gemhearts -= data.cost;
                    this.state.fabrials[type] = true;
                    this.log(`Fabricated ${data.name}.`, "text-purple-400 font-bold");
                    this.saveGame();
                    this.updateUI();
                }
            },
            recruit(type) {
                const amountInput = document.getElementById('recruit-amount');
                let amount = Math.max(1, parseInt(amountInput.value) || 1);
                
                const stats = this.getArmyStats(false); 
                if (stats.pop + amount > stats.cap) { this.log("Provision Cap Reached!", "text-red-400"); return; }

                if (type === 'shardbearers') {
                    amount = 1; 
                    if (this.state.gemhearts >= amount) {
                        this.state.gemhearts -= amount;
                        if (!this.state.military.shardbearers) this.state.military.shardbearers = 0;
                        this.state.military.shardbearers += amount;
                        this.log(`Recruited ${amount} Shardbearer(s).`, "text-cyan-400 font-bold");
                    } else {
                        this.log(`Not enough Gemhearts! Need ${amount}.`, "text-red-400");
                        return;
                    }
                } else {
                    const costPer = this.unitStats[type].cost;
                    const totalCost = costPer * amount;
                    if (this.state.spheres >= totalCost) {
                        this.state.spheres -= totalCost; 
                        if (!this.state.military[type]) this.state.military[type] = 0;
                        this.state.military[type] += amount;
                        this.log(`Recruited ${amount} ${type}.`, "text-slate-300");
                    } else {
                        this.log("Not enough spheres!", "text-red-400");
                        return;
                    }
                }
                this.saveGame();
                this.updateUI();
            },
            spyAction(action) {
                const targetKey = document.getElementById('spy-target').value;
                const target = this.npcPrinces[targetKey];
                const myAgents = this.getSpyPower();
                if (myAgents === 0) return;
                if (action === 'intel' && myAgents > target.agents) {
                    this.log(`INTEL: ${targetKey.toUpperCase()} Power: ${target.power}`, "text-cyan-400");
                } else if (action === 'steal_spheres' && myAgents >= target.agents * 1.5) {
                    this.state.spheres += 500; this.log("Stole 500 spheres.", "text-yellow-400");
                } else if (action === 'steal_shards' && myAgents >= target.agents * 3 && target.shardbearers > 0) {
                    target.shardbearers--; this.state.military.shardbearers++; this.log("Stole Shardblade!", "text-cyan-400");
                } else {
                    const spyTypes = ['noble', 'spy', 'ghostblood'];
                    const available = spyTypes.filter(t => this.state.military[t] > 0);
                    if(available.length > 0) {
                        const lossType = available[Math.floor(Math.random() * available.length)];
                        this.state.military[lossType]--;
                        this.log(`Spy mission failed. A ${lossType} was caught.`, "text-red-500");
                    } else { this.log("Spy mission failed.", "text-red-500"); }
                }
            },
            
            // NEW ARENA LOGIC
            startDuel() {
                if (this.state.arena.hp <= 0) {
                    this.log("Champion is injured and cannot fight until tomorrow.", "text-red-500");
                    return;
                }
                if (this.state.arena.dailyDuels >= 5) {
                    this.log("Champion is exhausted. Wait for tomorrow.", "text-yellow-400");
                    return;
                }
                
                this.state.arena.dailyDuels++;
                
                // Initialize Combat State
                this.state.activeDuel = {
                    playerHp: this.state.arena.hp,
                    playerMaxHp: this.state.arena.maxHp,
                    playerThrill: this.state.arena.maxThrill || 10,
                    
                    // Enemy scales slightly with player level
                    enemyHp: Math.max(3, this.state.arena.level + 1), 
                    enemyMaxHp: Math.max(3, this.state.arena.level + 1),
                    enemyThrill: (this.state.arena.maxThrill || 10) + Math.floor(Math.random() * 3),
                    
                    log: ["Duel Started. Place your bids."]
                };
                
                this.updateUI();
            },

            commitThrill() {
                if(!this.state.activeDuel) return;
                
                const input = document.getElementById('thrill-input');
                let bid = parseInt(input.value) || 0;
                
                // Validate Bid
                if(bid < 0) bid = 0;
                if(bid > this.state.activeDuel.playerThrill) bid = this.state.activeDuel.playerThrill;
                
                let enemyBid = Math.floor(Math.random() * (this.state.activeDuel.enemyThrill + 1));
                
                // Process Turn
                this.state.activeDuel.playerThrill -= bid;
                this.state.activeDuel.enemyThrill -= enemyBid;
                
                let msg = `You pushed ${bid}. Enemy pushed ${enemyBid}. `;
                let color = "text-slate-300";
                
                if (bid > enemyBid) {
                    this.state.activeDuel.enemyHp--;
                    msg += "YOU HIT!";
                    color = "text-green-400";
                } else if (enemyBid > bid) {
                    this.state.activeDuel.playerHp--;
                    msg += "ENEMY HIT!";
                    color = "text-red-400";
                } else {
                    msg += "CLASH!";
                    color = "text-yellow-200";
                }
                
                this.state.activeDuel.log.push(`<span class="${color}">${msg}</span>`);
                
                // Check Win/Loss
                if (this.state.activeDuel.playerHp <= 0) {
                    this.state.arena.hp = 0;
                    this.log("Duel Lost. Champion Injured.", "text-red-600 font-bold");
                    this.state.activeDuel = null;
                } else if (this.state.activeDuel.enemyHp <= 0) {
                    // Win Logic
                    this.state.arena.hp = this.state.activeDuel.playerHp; // Save current HP state
                    const reward = 50 * this.state.arena.level;
                    const xpGain = 10;
                    this.state.spheres += reward;
                    this.state.arena.xp += xpGain;
                    this.log(`Duel Won! +${reward} S, +${xpGain} XP`, "text-green-400 font-bold");
                    
                    if (this.state.arena.xp >= this.state.arena.level * 100) {
                        this.state.arena.level++;
                        this.state.arena.xp = 0;
                        this.state.arena.maxHp++;
                        this.state.arena.maxThrill = (this.state.arena.maxThrill || 10) + 1;
                        this.state.arena.hp = this.state.arena.maxHp;
                        this.log("Champion Level Up! +1 HP, +1 Thrill.", "text-yellow-400 font-bold");
                    }
                    this.state.activeDuel = null;
                } else {
                    // If no one dead, check if both out of thrill (Draw)
                    if(this.state.activeDuel.playerThrill === 0 && this.state.activeDuel.enemyThrill === 0) {
                        this.state.arena.hp = this.state.activeDuel.playerHp;
                        this.log("Duel ended in Draw (Exhaustion).", "text-slate-400");
                        this.state.activeDuel = null;
                    }
                }
                
                this.updateUI();
                
                // Reset input for convenience
                if(this.state.activeDuel) {
                    document.getElementById('thrill-input').max = this.state.activeDuel.playerThrill;
                    document.getElementById('thrill-input').value = Math.min(1, this.state.activeDuel.playerThrill);
                }
            },
            
            enterTournament() {
                if (!this.state.tournamentActive) return;
                
                if (this.state.arena.hp <= 0) {
                    this.log("Champion is injured! Cannot enter tournament.", "text-red-500 font-bold");
                    return;
                }
                
                const chance = 0.3 + (this.state.arena.level * 0.05);
                
                if (Math.random() < chance) {
                    this.state.gemhearts++;
                    this.log("TOURNAMENT CHAMPION! You won a Gemheart!", "text-purple-400 font-bold text-lg");
                } else {
                    this.log("Eliminated from tournament. Better luck next month.", "text-slate-400");
                }
                this.state.tournamentActive = false; 
                this.updateUI();
            },
            log(msg, color = 'text-slate-200') {
                const logEl = document.getElementById('game-log');
                if (logEl) {
                    const entry = document.createElement('div');
                    entry.className = `log-entry ${color}`;
                    entry.innerHTML = msg;
                    logEl.prepend(entry);
                }
            },
            setTab(tab) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tab-' + tab).classList.add('active');
                document.getElementById('panel-build').classList.add('hidden');
                document.getElementById('panel-military').classList.add('hidden');
                document.getElementById('panel-spy').classList.add('hidden');
                document.getElementById('panel-fabrial').classList.add('hidden');
                document.getElementById('panel-arena').classList.add('hidden');
                document.getElementById('panel-' + tab).classList.remove('hidden');
            },
            updateTimeUI() {
                const elapsed = Date.now() - this.state.startTime;
                const totalDays = Math.floor(elapsed / this.constants.DAY_MS);
                
                const daysPerYear = 168; // 7 months * 24 days
                const years = Math.floor(totalDays / daysPerYear) + 1;
                const remainingDays = totalDays % daysPerYear;
                const months = Math.floor(remainingDays / 24) + 1;
                const days = (remainingDays % 24) + 1;
                
                document.getElementById('display-date').innerText = `Year ${years}, Month ${months}, Day ${days}`;
                const msNext = this.constants.DAY_MS - (elapsed % this.constants.DAY_MS);
                const secs = Math.ceil(msNext / 1000);
                document.getElementById('display-time').innerText = `Next Day: ${secs}s`;
            },
            saveGame() {
                if(this.username) {
                    localStorage.setItem(`highprince_save_v17_${this.username}`, JSON.stringify(this.state));
                }
            },
            loadGame() {
                if(!this.username) return;
                const saved = localStorage.getItem(`highprince_save_v17_${this.username}`);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.state = {
                        ...this.state,
                        ...parsed,
                        military: { ...this.state.military, ...parsed.military },
                        buildings: { ...this.state.buildings, ...parsed.buildings },
                        fabrials: { ...this.state.fabrials, ...parsed.fabrials },
                        arena: { ...this.state.arena, ...parsed.arena }
                    };
                    if(parsed.activeRun) this.state.activeRun = parsed.activeRun;
                    if(parsed.deployments) this.state.deployments = parsed.deployments;
                    if(parsed.activeDuel) this.state.activeDuel = parsed.activeDuel;
                }
            },
            sendChat() {
                const input = document.getElementById('chat-input');
                if (!input.value.trim()) return;
                const chatBox = document.getElementById('chat-box');
                chatBox.innerHTML += `<p><b class="text-blue-300">You:</b> ${input.value}</p>`;
                input.value = '';
            }
        };

        window.onload = () => game.init();
    </script>
</body>
</html>
